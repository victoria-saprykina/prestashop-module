# Connection

### Вкладка “Соединение”

  

#### URL CRM

Вводится полный адрес системы (https://test.retailcrm.ru). Для ввода в поле можно использовать как адрес RetailCRM, так и Simla.com.  

#### API-ключ (API key)

Ключ должен иметь доступ только к одному магазину **(1 магазин = 1 ключ)**. Также для ключа должны быть разрешены все методы API *(рекомендуется)* в настройках системы.
 

### Включить выгрузку истории (Enable history uploads)

Для того, чтобы изменения по заказам и клиентам передавались **из CRM в PrestaShop**, требуется активировать данную опцию. История прогружается **раз в 7 минут**.

Обратите внимание, что PrestaShop вызывает **событие изменения** заказа в **3** случаях:

- при добавлении товара в заказ;
- при изменении существующего в заказе товара *(например, изменении его количества)*; 
- при удалении товара из заказа.
    
Во всех остальных случаях событие **не вызывается**. Таким образом, в силу специфики платформы PrestaShop, мы не можем передавать изменение, если были добавлены или изменены **только скидки в заказе**. Для передачи изменений по скидкам в систему необходимо, чтобы произошло дополнительное изменение из вышеуказанного списка.

### Получать остатки из Simla.com (Receive stocks from Simla.com)

Активируйте данную опцию для того, чтобы получать остатки по товарам из CRM в PrestaShop. Остатки выгружаются **раз в 15 минут**.

### Номер заказа (Order number)

Данные опции позволяют передавать номер заказа при синхронизации заказов между PrestaShop и Simla.com.

### Опция ("Передавать номер заказа в Simla.com") "Send order number to Simla.com"

|  Статус     |  Номер заказа в PrestaShop  |  Номер заказа в Simla.com                                      |
|-------------|-----------------------------|----------------------------------------------------------------|
|  Включена   |  `reference`                |  `reference`                                                   |
|  Выключена  |  `reference`                |  Cоответствует шаблону в CRM для заказа, созданного через API  |

### Опция Получать номер заказа из Simla.com ("Receive order number from Simla.com")

|  Статус     |  Номер заказа в Simla.com     |  Номер заказа в PrestaShop                                   |
|-------------|-------------------------------|--------------------------------------------------------------|
|  Включена   |  Cоответствует шаблону в CRM  |  Cоответствует шаблону в CRM                                 |
|  Выключена  |  Cоответствует шаблону в CRM  |  `reference`                                                 |

Вернуть логику передачи внешнего ID заказа в Simla.com можно путём указания в настройках CRM в поле "Шаблон генерации номера заказа из API" значения `{external_id}`.

### Корпоративные клиенты (Corporate clients)

Для того, чтобы активировать передачу корпоративных клиентов, необходимо активировать данную опцию. В CRM также должен быть активен функционал корп клиентов.

В PrestaShop клиент считается корпоративным, если заполнено поле **Компания** в **Платежном адресе** *(Invoice address)* в профиле клиента.

При регистрации покупателя с необходимыми данными, в CRM будет выгружен новый клиент, как *обычное физ лицо*, однако, если этот клиент оформит заказ, то в CRM будет создан корп клиент с наименованием из поля *Компания*, а клиент станет *Контактным лицом* данного корп клиента. Тип клиента **не изменится** на Контактное лицо, а останется Клиентом *(будет исправлено в задаче #77333)*.

В карточке корп клиента указаны: 
- Наименование, 
- Магазин, 
- Дата регистрации. <br/>
**В блоке Контактные лица**: 
- ФИО клиента, 
- Email, 
- Email-подписка *(значение указано в зависимости от флага подписки на сайте)*, 
- Дата рождения, 
- признак Основное *(только у первого выгружаемого Контактного лица)*, 
- Телефон, 
- нет привязки к Компании. <br>
**В блоке Компании**: 
- Название, 
- Статус, 
- признак Основная *(только у первой выгружаемой Компании)*, 
- Тип контрагента *(Юр лицо)*, 
- Адрес регистрации *(из Платежного адреса)*, 
- есть привязка к адресу. <br>
**В блоке Адреса**: 
- указан Платежный адрес *(заполнены все строки)*, 
- есть привязка к Компании.

В карточку контактного лица в данные адреса выгружается **Платежный адрес**.

Функционал добавлен начиная с версии 3.0.5.
